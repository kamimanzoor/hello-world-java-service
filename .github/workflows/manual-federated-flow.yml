name: Manual Federation Test

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Get GitHub OIDC Token
        id: oidc
        run: |
          echo "Requesting OIDC token..."
          TOKEN=$(curl -s \
            -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=api://AzureADTokenExchange" \
            | jq -r '.value')

          echo "OIDC_TOKEN=$TOKEN" >> $GITHUB_ENV

          echo "Decoded OIDC token:"
          echo $TOKEN | cut -d '.' -f2 | base64 -d | jq

      - name: Exchange OIDC Token with Entra
        run: |
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=3f3f8408-d79a-48fe-bfa8-95a4d25494dd" \
            -d "scope=api://5ed39923-a4c5-4366-a547-c0f45df4a8a7/.default" \
            -d "grant_type=client_credentials" \
            -d "client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer" \
            -d "client_assertion=$OIDC_TOKEN" \
            https://login.microsoftonline.com/1f3f2503-0e72-4067-8f83-e255d2bdd630/oauth2/v2.0/token)

          echo $RESPONSE | jq

          ACCESS_TOKEN=$(echo $RESPONSE | jq -r '.access_token')

          echo "Decoded Access Token:"
          echo $ACCESS_TOKEN | cut -d '.' -f2 | base64 -d | jq
