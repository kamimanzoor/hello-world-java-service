name: Windows EXE Build

on: [push]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
        working-directory: defender-poc

      # Optional: install app deps if you have them
      # - name: Install app requirements
      #   run: pip install -r requirements.txt
      #   working-directory: defender-poc

      - name: Build Windows EXE
        run: |
          pyinstaller --onefile --clean --name ReputationTest app.py
        working-directory: defender-poc

      - name: Add signtool to PATH
        shell: powershell
        run: |
          $sdkPath = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\10\bin" -Directory | 
            Where-Object { $_.Name -match '^\d+\.\d+\.\d+\.\d+$' } | 
            Sort-Object Name -Descending | 
            Select-Object -First 1
          $signtoolPath = Join-Path $sdkPath.FullName "x64"
          echo "$signtoolPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Import signing cert
        shell: powershell
        run: |
          $bytes = [Convert]::FromBase64String("${{ secrets.CODESIGN_PFX_BASE64 }}")
          $path = "$env:TEMP\codesign.pfx"
          [IO.File]::WriteAllBytes($path, $bytes)

          $pwd = ConvertTo-SecureString "${{ secrets.CODESIGN_PFX_PASSWORD }}" -AsPlainText -Force

          # Import to personal store for signing
          Import-PfxCertificate `
            -FilePath $path `
            -CertStoreLocation Cert:\CurrentUser\My `
            -Password $pwd

      - name: Sign EXE
        shell: powershell
        run: |
          signtool sign `
            /fd SHA256 `
            /n "GitHub Internal Code Signing" `
            /tr http://timestamp.digicert.com `
            /td SHA256 `
            defender-poc\dist\ReputationTest.exe

      - name: Verify signature
        shell: powershell
        run: |
          $sig = Get-AuthenticodeSignature -FilePath defender-poc\dist\ReputationTest.exe
          Write-Output "Status : $($sig.Status)"
          Write-Output "Signer : $($sig.SignerCertificate.Subject)"
          Write-Output "Thumbprint: $($sig.SignerCertificate.Thumbprint)"
          if ($sig.Status -notin 'Valid','UnknownError') {
            # UnknownError = valid sig but cert not in trusted root (expected for self-signed)
            throw "Signature check failed: $($sig.Status) - $($sig.StatusMessage)"
          }
        
      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: ReputationTest
          path: defender-poc/dist/*.exe
