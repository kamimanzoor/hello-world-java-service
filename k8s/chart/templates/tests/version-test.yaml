apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Values.deploy.name }}-version-test"
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: "{{ .Values.deploy.name }}-version-test"
      image: "mcr.microsoft.com/azure-cli:latest"
      imagePullPolicy: Always
      command:
        - /bin/bash
        - -ec
        - |
          result_json=$(curl http://"{{ .Values.deploy.name }}":8080/info) || result_code=$?
          if (( result_code > 0 ))
          then
            echo "non zero code executing curl"
            exit 1
          fi

          version=$(echo "${result_json}" | jq -r '.version')
          if [[ ${version} != "{{ .Values.image.version }}" ]]
          then
            echo "wrong version: ${version} != "{{ .Values.image.version }}""
            exit 2
          fi

          echo "successfully validated  component version ${version}"
  restartPolicy: Never